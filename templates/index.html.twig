{% extends "base.html.twig" %}
{% block body %}
    <div class="container-fluid">
    <div class="row">
        <div class="col-sm">
            {% include"header.html.twig" %}
        </div>
    </div>
    <div class="row">
        <div class="col-1">
            {% include "menu.html.twig" %}
        </div>
        <div class="col-8" >
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <div id="jsGrid"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const DATE_FORMAT = 'DD-MM-YYYY';
        const setWeekDates = (startOfWeek, endOfWeek) => {
            let i;
            const selectedWeekDays = [];
            for (i = startOfWeek; i <= endOfWeek; i++) {
                selectedWeekDays.push(moment().day(i).format(DATE_FORMAT));
            }
            return selectedWeekDays;
        };
        const setMonthDates = (selectedMonth) => {
            let i;
            const selectedMonthDays = [];
            const daysInMonth = moment().month(selectedMonth).daysInMonth();

            for (i = 1; i <= daysInMonth; i++) {
                selectedMonthDays.push(moment().month(selectedMonth).date(i).format(DATE_FORMAT));
            }
            return selectedMonthDays;
        };
        const setYearDates = (year) => {
            let i;
            const selectedYearDates = [];
            for (let i = 0; i < 366; i++) {
                selectedYearDates.push(moment().year(year).dayOfYear(i).format(DATE_FORMAT));
            }
            return selectedYearDates;
        };

        const readAllEventsRoute = "{{ path('read_all_calendar_events')|escape('js') }}";
        const readEventByIdRoute = "{{ path('read_calendar_event_by_id', {calendarEventId: '1'})|escape('js') }}";
        const readAllUsersRoute = "{{ path('read_all_users')|escape('js') }}";
        const createRoute = "{{ path('create_event')|escape('js') }}";
        const updateRoute = "{{ path('update_calendar_event_by_id',{calendarEventId: 1})|escape('js') }}";
        const teamColumn = {name: 'Team', type: "text", width: 150, editing: false};
        const columns = setWeekDates(0, 6).map(date => {
            return {name: date, type: "text", width: 180, validate: "required", align: 'center'}
        });
        columns.unshift(teamColumn);
        const fields = columns;
        let getAllDataAjaxCall = $.ajax({
            type: "GET",
            url: readAllEventsRoute,
            dataType: "json"
        }).then(function (result) {
            return result;
        });

        let getAllUsersAjaxCall = $.ajax({
            type: "GET",
            url: readAllUsersRoute,
            dataType: "json"
        }).then(function (result) {
            return result;
        });
        const grid = $("#jsGrid").jsGrid({
            controller: {
                loadData: function (filter) {
                    return $.when(getAllDataAjaxCall, getAllUsersAjaxCall).then(function (a1, a2) {
                        const users = _.each(a2, user => {
                            user['Team'] = user.fullName;
                        });
                        a1.map(item => {
                            item[moment(item.eventDate).format('DD-MM-YYYY')] = item.eventType
                        });
                        return _.each(users, user => {
                            _.each(a1, item => {
                                    if (item.userId === user.id) {
                                        Object.assign(user, item)
                                    }
                                }
                            )
                        });
                    });
                },
                width: "100%",
                height: "750",
                insertItem: $.noop,
                updateItem: $.noop,
                deleteItem: $.noop
            },
            inserting: false,
            editing: false,
            sorting: false,
            paging: false,
            autoload: true,
            fields
        });
    </script>
{% endblock %}